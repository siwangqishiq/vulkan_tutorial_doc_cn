# 生成多级纹理

## 介绍

我们的程序现在已经可以导入并渲染3D模型了,在本章,我们会添加一个新的特性,多级纹理的生成。多级纹理被广泛使用于游戏及渲染软件中,并且Vulkan为我们提供了对多级纹理从创建开始的完全控制。

多级纹理是一组预先计算好的,降采样版本的图像,每一个新图像都相较于前一个是宽高尺寸的一半,多级纹理也被称之为LOD(Level Of Detail),对象若是距离摄像机更远，则会采用更小的多级纹理,使用更小的图像会获得更高的渲染速度并避免摩尔纹的产生,多级纹理看上去如下:

![mipmaps_example](imgs/mipmaps_example.jpg)

## 图像创建

在Vulkan中,每一个多级图像都被存储为 不同的 VkImage 的不同级别对象,Mip 等级为0代表原始图像,0之后的级别通常被称之为mip链.

在 vkImage 创建的时候指定 mip 的数量,到目前为止，我们都设置这个值为1,现在我们需要计算图像的维度,首先添加一个成员变量去存储这个数值.

```C++
uint32_t mipLevels;
VkImage textureImage;
```

这个mipLevel的值可以在我们导入纹理资源的时候予以指定:

```C++
int texWidth,texHeight,texChannel;

stbi_uc* pixels = stbi_load(TEXTURE_PATH.c_str(), &texWidth, &texHeight, &texChannels, STBI_rgb_alpha);
...

mipLevels = static_cast<uint32_t>(std::floor(std::log2(std::max(texWidth, texHeight)))) + 1;
```

这会计算出 mip 链的数量,max函数选择出宽高里面更大的值,log2函数则计算出了数值的对数,floor 函数进行四舍五入处理数值若不是2的N次方的情况, +1操作是因为原始图像也占据了一个mip等级( =0 )

为了使用这个值，我们需要去修改 createImage,createImageView,transitionImageLayout 函数,允许我们可以自行指定mip的等级,给这些函数添加一个 mipLevels 的参数.

```C++
void createImage(uint32_t width, 
    uint32_t height, 
    uint32_t mipLevels, 
    VkFormat format, 
    VkImageTiling tiling, 
    VkImageUsageFlags usage, 
    VkMemoryPropertyFlags properties, 
    VkImage& image, 
    VkDeviceMemory& imageMemory){
    
    ...
    imageInfo.mipLevels = mipLevels;
    ...
}
```

```C++
VkImageView createImageView(
    VkImage image, 
    VkFormat format, 
    VkImageAspectFlags aspectFlags, uint32_t mipLevels) {
    ...
    viewInfo.subresourceRange.levelCount = mipLevels;
    ...
```

```C++
void transitionImageLayout(
    VkImage image, 
    VkFormat format, VkImageLayout oldLayout, VkImageLayout newLayout, uint32_t mipLevels) {
    ...
    barrier.subresourceRange.levelCount = mipLevels;
    ...
```

## 生成多级纹理

## 线性过滤的支持

## 采样器